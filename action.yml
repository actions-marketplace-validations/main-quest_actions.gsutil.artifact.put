name: "Put artifact on GCS"
description: "Uses main-quest/actions.gsutil"
inputs:
  key:
    description: "Service account json key, base64 encrypted or not"
    required: true
  bucket:
    description: |
      "Specify bucket name or leave empty to use the one generated by main-quest/actions.gsutil.artifact.bucketname"
    required: false
  name:
    description: "Artifact name. Artifacts are stored in folders under <bucket>/run-<run-id>/<artifact-name>/"
    required: true
  path:
    description: "Source file/dir"
    required: true
  zip:
    description: "Upload a single zip file with all the files at 'path'"
    required: false
    default: false
    
runs:
  using: "composite"
  steps:  
      - name: Get bucket name
        id: namer
        uses: main-quest/actions.gsutil.artifact.bucketname@v0.0.2
        with:
          bucket: ${{ inputs.bucket }}

      - name: Upload raw
        uses: main-quest/actions.gsutil@v0.0.8
        if: ${{ inputs.zip == 'false' }}
        with:
          key: ${{ inputs.key }}
          do: -m cp -r "${{ inputs.path }}" "gs://${{ steps.namer.outputs.bucket_name }}/${{ github.run_id }}/${{ inputs.name }}/"

      - name: Zip files if asked to
        id: zip_preparer
        if: ${{ inputs.zip == 'true' }}
        shell: bash
        run: |
          d="${{ inputs.name }}"__zipped
          mkdir -p "$d"
          f="$d"/"${{ inputs.name }}.zip"
          zip -r "$f" "${{ inputs.path }}"
          echo "::set-output name=file_path::$f"

      - name: Upload zipped if asked to
        uses: main-quest/actions.gsutil@v0.0.8
        if: ${{ inputs.zip == 'true' }}
        with:
          key: ${{ inputs.key }}
          do: -m cp -r "${{ steps.zip_preparer.outputs.file_path }}" "gs://${{ steps.namer.outputs.bucket_name }}/${{ github.run_id }}/${{ inputs.name }}/"
